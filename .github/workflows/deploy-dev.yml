name: Deploy to Dev

on:
  push:
    branches:
      - development

env:
  AWS_REGION: sa-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.sa-east-1.amazonaws.com
  BACKEND_IMAGE_NAME: revendiste/backend-dev
  FRONTEND_IMAGE_NAME: revendiste/frontend-dev
  FRONTEND_DIR: apps/frontend

jobs:
  build-backend:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract backend metadata
        id: backend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/backend.Dockerfile
          push: true
          tags: ${{ steps.backend-meta.outputs.tags }}
          labels: ${{ steps.backend-meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:buildcache,mode=max

  build-frontend:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract frontend metadata
        id: frontend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/frontend.Dockerfile
          push: true
          tags: ${{ steps.frontend-meta.outputs.tags }}
          labels: ${{ steps.frontend-meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:buildcache,mode=max

  deploy-backend:
    runs-on: ubuntu-latest
    needs: build-backend
    environment: development

    steps:
      - name: Deploy backend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_APP_HOST }}
          username: ec2-user
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # Login to ECR (IAM role handles authentication)
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

            # Pull latest backend image (try development tag first, then latest)
            docker pull ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:development || docker pull ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest

            # Stop and remove old backend container
            docker stop revendiste-backend || true
            docker rm revendiste-backend || true

            # Get secret from AWS Secrets Manager and convert to Docker env file format
            set +e
            SECRET_JSON=$(aws secretsmanager get-secret-value \
              --secret-id revendiste/dev/backend-secrets \
              --region ${{ env.AWS_REGION }} \
              --query 'SecretString' \
              --output text 2>&1)
            SECRET_EXIT_CODE=$?
            set -e

            if [ $SECRET_EXIT_CODE -ne 0 ]; then
              echo "Error: Failed to retrieve secret from AWS Secrets Manager"
              echo "$SECRET_JSON"
              echo ""
              if echo "$SECRET_JSON" | grep -q "ResourceNotFoundException\|can't find the specified secret value"; then
                echo "The secret exists but has no value. Please add a secret value:"
                echo "aws secretsmanager put-secret-value \\"
                echo "  --secret-id revendiste/dev/backend-secrets \\"
                echo "  --secret-string '{\"KEY\":\"value\"}' \\"
                echo "  --region ${{ env.AWS_REGION }}"
              else
                echo "This usually means the EC2 instance IAM role doesn't have permission."
                echo "Please run 'terraform apply' to ensure IAM policies are up to date."
              fi
              exit 1
            fi

            # Check if secret value is empty
            if [ -z "$SECRET_JSON" ] || [ "$SECRET_JSON" = "null" ]; then
              echo "Error: Secret exists but has no value"
              echo "Please add a secret value using:"
              echo "aws secretsmanager put-secret-value \\"
              echo "  --secret-id revendiste/dev/backend-secrets \\"
              echo "  --secret-string '{\"KEY\":\"value\"}' \\"
              echo "  --region ${{ env.AWS_REGION }}"
              exit 1
            fi

            # Convert JSON to KEY=VALUE format (one per line) for Docker --env-file
            ENV_FILE=$(mktemp)
            echo "$SECRET_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' > "$ENV_FILE"

            # Determine which image tag to use
            IMAGE_TAG="development"
            if ! docker image inspect ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:development >/dev/null 2>&1; then
              IMAGE_TAG="latest"
            fi

            # Run new backend container with all environment variables from secrets
            docker run -d \
              --name revendiste-backend \
              --restart unless-stopped \
              -p 3001:3001 \
              --env-file "$ENV_FILE" \
              ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:$IMAGE_TAG

            # Clean up temp file
            rm -f "$ENV_FILE"

            # Wait for migrations and server startup (migrations can take time)
            echo "Waiting for migrations and server to start..."
            sleep 30

            # Check if container is still running (if it exited, migrations or server startup failed)
            if ! docker ps | grep -q revendiste-backend; then
              echo "Error: Container exited immediately. Checking logs..."
              docker logs revendiste-backend
              exit 1
            fi

            # Check container logs for errors
            echo "Container logs:"
            docker logs revendiste-backend --tail 50

            # Health check with retries (migrations may still be running)
            echo "Performing health check (migrations may still be running)..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3001/api/health >/dev/null 2>&1; then
                echo "Health check passed!"
                exit 0
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Health check failed, retry $RETRY_COUNT/$MAX_RETRIES (migrations may still be running)..."
              sleep 10
            done

            # If we get here, health check failed
            echo "Error: Health check failed after $MAX_RETRIES attempts"
            echo "Container logs:"
            docker logs revendiste-backend --tail 100
            exit 1

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-frontend
    environment: development

    steps:
      - name: Deploy frontend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_APP_HOST }}
          username: ec2-user
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # Login to ECR (IAM role handles authentication)
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

            # Pull latest frontend image (try development tag first, then latest)
            docker pull ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:development || docker pull ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest

            # Stop and remove old frontend container
            docker stop revendiste-frontend || true
            docker rm revendiste-frontend || true

            # Determine which image tag to use
            IMAGE_TAG="development"
            if ! docker image inspect ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:development >/dev/null 2>&1; then
              IMAGE_TAG="latest"
            fi

            # Run new frontend container with environment variables
            docker run -d \
              --name revendiste-frontend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e VITE_APP_API_URL="${{ secrets.VITE_APP_API_URL }}" \
              -e VITE_PLATFORM_COMMISSION_RATE="${{ secrets.VITE_PLATFORM_COMMISSION_RATE || '0.06' }}" \
              -e VITE_VAT_RATE="${{ secrets.VITE_VAT_RATE || '0.22' }}" \
              ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:$IMAGE_TAG

            # Health check
            sleep 5
            curl -f http://localhost:3000 || exit 1
